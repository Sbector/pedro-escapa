---
import Layout from "@layouts/Layout.astro";
import { menu } from "@lib/menu";
import { getSubitemData } from "@lib/getSubitemData";
import { getCollection, render } from "astro:content";
import Carousel from "@components/Carousel.jsx";
import Wrapper from "@components/Wrapper.astro";

export async function getStaticPaths() {
  const paths = [];

  for (const item of menu) {
    if (item.visible !== false && item.subitems) {
      for (const sub of item.subitems) {
        if (sub.visible !== false) {
          paths.push({
            params: {
              categoria: item.id,
              slug: sub.slug,
            },
          });
        }
      }
    }
  }

  return paths;
}

const { categoria, slug } = Astro.params;
const subitemData = getSubitemData(menu, categoria, slug);

if (!subitemData) {
  throw new Error(`No se encontró el subitem: ${categoria}/${slug}`);
}

// Construir la ruta actual explícitamente
const currentPath = `/${categoria}/${slug}`;

// Traer la colección de imágenes
const itemCollections = await getCollection("itemCollections");
const collection = itemCollections.find((item) => item.id === slug);

// Traer la colección de descripciones
const descriptions = await getCollection("descriptions");

let DescriptionContent = null;
if (collection?.data?.description) {
  const descriptionRef = collection.data.description;

  // Buscar la descripción por su id
  // Si es una referencia, usar el id; si es un string, usar directamente
  const refId =
    typeof descriptionRef === "string" ? descriptionRef : descriptionRef.id;
  const descriptionEntry = descriptions.find((desc) => desc.id === refId);

  if (descriptionEntry) {
    const { Content } = await render(descriptionEntry);
    DescriptionContent = Content;
  }
}
---

<Layout
  title={`${collection?.data.title} · Pedro Escapa`}
  currentPath={currentPath}
>
  <div class="h-full w-full overflow-y-auto snap-y snap-mandatory">
    {
      DescriptionContent && (
        <div
          class="prose prose-sm 
          prose-headings:text-2xl prose-headings:pt-8
          prose-strong:text-2xl
          max-w-none min-h-full
          pt-8 lg:pt-40 
          pb-16 lg:pb-48 
          px-6 lg:px-20
          text-justify
          snap-start"  
        >
          <DescriptionContent pb-16/>
          <!-- Botón -->
          <div class="not-prose mt-12 flex justify-center">
            <button
              id="scroll-to-carousel"
              class="inline-flex items-center gap-2
                    px-4 py-2
                    text-sm
                    hover:bg-neutral-100
                    transition"
            >
              ↓
            </button>
          </div>
        </div>
      )
    }

    <Wrapper id="carousel-section" className="min-h-full snap-start">
  {
    (collection?.data?.images || collection?.data?.video) && (
      <Carousel 
        client:load 
        items={[
          ...collection.data.images, 
          ...(collection.data.video ? [collection.data.video] : [])
        ]} 
        mode={collection.data.carouselMode}
      />
    )
  }
</Wrapper>
  </div>

  <script>
    function setupScrollButton() {
      const button = document.getElementById("scroll-to-carousel");
      const target = document.getElementById("carousel-section");

      if (!button || !target) return;

      button.onclick = () => {
        target.scrollIntoView({ behavior: "smooth", block: "start" });
      };
    }

  // Primera carga
    setupScrollButton();

  // Navegación Astro (View Transitions)
    document.addEventListener("astro:page-load", setupScrollButton);
  </script>
</Layout>

